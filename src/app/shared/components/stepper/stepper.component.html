<div *ngIf="state && state.isOpen" class="stepper-overlay">
  <div class="stepper-modal">
    <!-- Header -->
    <div class="stepper-header">
      <h2>Create Product</h2>
      <button class="close-btn" (click)="closeStepper()">
        <ion-icon name="close"></ion-icon>
      </button>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress" [style.width.%]="(state.currentStep / 4) * 100"></div>
    </div>

    <!-- Step Indicators -->
    <div class="step-indicators">
      <div class="step-indicator" 
           [class.active]="state.currentStep === 1"
           [class.completed]="state.currentStep > 1"
           (click)="goToStep(1)">
        <span>1</span>
        <p>Product</p>
      </div>
      <div class="step-indicator" 
           [class.active]="state.currentStep === 2"
           [class.completed]="state.currentStep > 2"
           (click)="state.currentStep >= 2 && goToStep(2)">
        <span>2</span>
        <p>Details</p>
      </div>
      <div class="step-indicator" 
           [class.active]="state.currentStep === 3"
           [class.completed]="state.currentStep > 3"
           (click)="state.currentStep >= 3 && goToStep(3)">
        <span>3</span>
        <p>Category</p>
      </div>
      <div class="step-indicator" 
           [class.active]="state.currentStep === 4"
           [class.completed]="state.currentStep > 4"
           (click)="state.currentStep >= 4 && goToStep(4)">
        <span>4</span>
        <p>Brand</p>
      </div>
    </div>

    <!-- Content Container -->
    <div class="stepper-content">
      
      <!-- STEP 1: Product Name and Basic Info -->
      <div class="step-content" *ngIf="state.currentStep === 1">
        <h3>Let's start with the basics</h3>
        <p class="step-description">Enter your product name and initial details</p>
        
        <ion-item>
          <ion-label position="stacked">Product Name *</ion-label>
          <ion-input 
            [(ngModel)]="state.perfumeData.name"
            (ionInput)="updatePerfumeData('name', $event.detail.value!)"
            placeholder="e.g., Rose Perfume Premium">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Description *</ion-label>
          <ion-textarea 
            [(ngModel)]="state.perfumeData.description"
            (ionInput)="updatePerfumeData('description', $event.detail.value!)"
            placeholder="Describe the scent..."
            rows="3">
          </ion-textarea>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Gender</ion-label>
          <ion-select 
            [(ngModel)]="state.perfumeData.genre"
            (ionChange)="updatePerfumeData('genre', $event.detail.value)">
            <ion-select-option value="Masculino">Masculino</ion-select-option>
            <ion-select-option value="Femenino">Femenino</ion-select-option>
            <ion-select-option value="Unisex">Unisex</ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <!-- STEP 2: Price, Stock, Size -->
      <div class="step-content" *ngIf="state.currentStep === 2">
        <h3>Product Details</h3>
        <p class="step-description">Enter pricing and inventory information</p>

        <ion-item>
          <ion-label position="stacked">Price ($) *</ion-label>
          <ion-input 
            type="number"
            [(ngModel)]="state.perfumeData.price"
            (ionInput)="updatePerfumeData('price', +$event.detail.value!)"
            placeholder="150">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Stock (Units) *</ion-label>
          <ion-input 
            type="number"
            [(ngModel)]="state.perfumeData.stock"
            (ionInput)="updatePerfumeData('stock', +$event.detail.value!)"
            placeholder="10">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="stacked">Size (ml) *</ion-label>
          <ion-input 
            type="number"
            [(ngModel)]="state.perfumeData.sizeMl"
            (ionInput)="updatePerfumeData('sizeMl', +$event.detail.value!)"
            placeholder="100">
          </ion-input>
        </ion-item>
      </div>

      <!-- STEP 3: Category Selection -->
      <div class="step-content" *ngIf="state.currentStep === 3">
        <h3>Select Category</h3>
        <p class="step-description">Choose the fragrance category that best describes your product</p>

        <!-- Option to use existing category -->
        <ion-item class="ion-margin-bottom">
          <ion-checkbox slot="start" [(ngModel)]="useExistingCategory"></ion-checkbox>
          <ion-label>Use existing category</ion-label>
        </ion-item>

        <!-- Existing categories dropdown -->
        <div *ngIf="useExistingCategory" class="ion-margin-bottom">
          <ion-item>
            <ion-label position="stacked">Select Category</ion-label>
            <ion-select 
              [(ngModel)]="state.selectedCategory"
              (ionChange)="selectCategory($event.detail.value)">
              <ion-select-option *ngFor="let category of state.categories" [value]="category.id">
                {{ category.name }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <!-- New category form -->
        <div *ngIf="!useExistingCategory">
          <ion-item class="ion-margin-bottom">
            <ion-label position="stacked">Category Name *</ion-label>
            <ion-input 
              [(ngModel)]="newCategoryName"
              placeholder="e.g., Premium Fragrances">
            </ion-input>
          </ion-item>

          <ion-item class="ion-margin-bottom">
            <ion-label position="stacked">Description *</ion-label>
            <ion-textarea 
              [(ngModel)]="newCategoryDescription"
              placeholder="e.g., Luxury perfume collection"
              rows="3">
            </ion-textarea>
          </ion-item>
        </div>
      </div>

      <!-- STEP 4: Brand Selection/Creation -->
      <div class="step-content" *ngIf="state.currentStep === 4">
        <h3>Select or Create Brand</h3>
        <p class="step-description">Choose an existing brand or create a new one</p>

        <!-- Option to use existing brand -->
        <ion-item class="ion-margin-bottom">
          <ion-checkbox slot="start" [(ngModel)]="useExistingBrand"></ion-checkbox>
          <ion-label>Use existing brand</ion-label>
        </ion-item>

        <!-- Existing brands dropdown -->
        <div *ngIf="useExistingBrand" class="ion-margin-bottom">
          <ion-item>
            <ion-label position="stacked">Select Brand</ion-label>
            <ion-select 
              [(ngModel)]="state.selectedBrand"
              (ionChange)="selectBrand($event.detail.value)">
              <ion-select-option *ngFor="let brand of state.brands" [value]="brand.id">
                {{ brand.name }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </div>

        <!-- New brand form -->
        <div *ngIf="!useExistingBrand">
          <ion-item class="ion-margin-bottom">
            <ion-label position="stacked">Brand Name *</ion-label>
            <ion-input 
              [(ngModel)]="newBrandName"
              placeholder="e.g., Luxury Scents">
            </ion-input>
          </ion-item>

          <ion-item class="ion-margin-bottom">
            <ion-label position="stacked">Description *</ion-label>
            <ion-textarea 
              [(ngModel)]="newBrandDescription"
              placeholder="e.g., Premium fragrance brand from France"
              rows="3">
            </ion-textarea>
          </ion-item>

          <ion-item class="ion-margin-bottom">
            <ion-label position="stacked">Country of Origin</ion-label>
            <ion-input 
              [(ngModel)]="newBrandCountry"
              placeholder="e.g., France">
            </ion-input>
          </ion-item>
        </div>
      </div>

    </div>

    <!-- Navigation Buttons -->
    <div class="stepper-footer">
      <ion-button 
        *ngIf="state.currentStep > 1"
        fill="outline"
        (click)="previousStep()">
        <ion-icon slot="start" name="chevron-back"></ion-icon>
        Back
      </ion-button>

      <div class="flex-spacer"></div>

      <ion-button 
        fill="outline"
        (click)="closeStepper()">
        Cancel
      </ion-button>

      <ion-button 
        *ngIf="state.currentStep < 4"
        [disabled]="!validateCurrentStep()"
        (click)="nextStep()">
        Next
        <ion-icon slot="end" name="chevron-forward"></ion-icon>
      </ion-button>

      <ion-button 
        *ngIf="state.currentStep === 4"
        [disabled]="!validateCurrentStep() || isLoading"
        (click)="savePerfume()">
        <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
        <ion-icon *ngIf="!isLoading" slot="start" name="checkmark"></ion-icon>
        {{ isLoading ? 'Creating...' : 'Save Product' }}
      </ion-button>
    </div>
  </div>
</div>