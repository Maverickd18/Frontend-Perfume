<ion-header>
  <ion-toolbar>
    <ion-title>Perfumes</ion-title>
    <ion-buttons slot="end" style="gap: 8px;">
      <ion-searchbar 
        placeholder="Buscar perfumes..."
        [value]="searchQuery"
        (ionInput)="onSearchChange($event)"
        debounce="300"
        style="padding: 0; margin-right: 8px;"
        class="custom-searchbar">
      </ion-searchbar>
      
      <!-- Header buttons para CLIENTE (sin campanita de notificaciones) -->
      <app-header-buttons
        (homeClicked)="ngOnInit()"
        (cartClicked)="onCartClick()"
        (profileClicked)="goProfile()"
        (logoutClicked)="logout()">
      </app-header-buttons>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Overlay para filtros -->
  <div class="filter-overlay" *ngIf="showFilters" (click)="showFilters = false"></div>

  <!-- Sidebar de filtros -->
  <div class="filter-sidebar" [class.open]="showFilters">
    <div class="filter-header">
      <h2>Filtros</h2>
      <button class="close-button" (click)="showFilters = false">
        <ion-icon name="close-outline"></ion-icon>
      </button>
    </div>

    <div class="filter-content">
      <!-- Categoría -->
      <div class="filter-section">
        <h3 class="filter-title">Categoría</h3>
        <div class="filter-options">
          <label class="filter-option" *ngFor="let category of availableCategories">
            <input 
              type="checkbox" 
              [checked]="filterCategory.includes(category)" 
              (change)="toggleFilterCategory(category)">
            <span>{{ category }}</span>
          </label>
        </div>
      </div>

      <!-- Marca -->
      <div class="filter-section">
        <h3 class="filter-title">Marca</h3>
        <div class="filter-options">
          <label class="filter-option" *ngFor="let brand of availableBrands">
            <input 
              type="checkbox" 
              [checked]="filterBrand.includes(brand)" 
              (change)="toggleFilterBrand(brand)">
            <span>{{ brand }}</span>
          </label>
        </div>
      </div>

      <!-- Tamaño -->
      <div class="filter-section">
        <h3 class="filter-title">Tamaño</h3>
        <div class="filter-options">
          <label class="filter-option" *ngFor="let size of availableSizes">
            <input 
              type="checkbox" 
              [checked]="filterSize.includes(size)" 
              (change)="toggleFilterSize(size)">
            <span>{{ size }}</span>
          </label>
        </div>
      </div>

      <!-- Precio -->
      <div class="filter-section">
        <h3 class="filter-title">Precio</h3>
        <div class="price-range">
          <div class="price-display">${{ filterPriceRange[0] }} - ${{ filterPriceRange[1] }}</div>
          <input 
            type="range" 
            min="0" 
            max="500" 
            [(ngModel)]="filterPriceRange[0]"
            (change)="onFilterChange()"
            class="range-input">
          <input 
            type="range" 
            min="0" 
            max="500" 
            [(ngModel)]="filterPriceRange[1]"
            (change)="onFilterChange()"
            class="range-input">
        </div>
      </div>
    </div>

    <div class="filter-actions">
      <button class="btn-primary" (click)="applyFilters()">Mostrar resultados</button>
      <button class="btn-secondary" (click)="clearFilters()">Borrar todo</button>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="products-list">
    <!-- Estado de carga -->
    <div *ngIf="isLoading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Cargando productos...</p>
    </div>

    <!-- Estado de error -->
    <div *ngIf="!isLoading && hasError" class="error-container">
      <ion-icon name="warning-outline"></ion-icon>
      <h3>Error de conexión</h3>
      <p>{{ errorMessage }}</p>
      <button class="retry-button" (click)="loadInitialData()">Reintentar</button>
    </div>

    <!-- Contenido cuando hay productos -->
    <div *ngIf="!isLoading && !hasError && allProducts.length > 0">
      <!-- Botón flotante de filtros -->
      <button class="floating-filter-button" (click)="toggleFilters()" title="Toggle filters">
        <ion-icon name="filter-outline"></ion-icon>
      </button>

      <!-- Contador de productos -->
      <div style="padding: 0 12px; margin-bottom: 1rem; text-align: center;">
        <p style="margin: 0; color: #666; font-size: 14px;">
          Mostrando {{ filteredProductsCount }} de {{ totalProductsCount }} productos
        </p>
      </div>

      <!-- Grid de productos -->
      <div class="grid">
        <div class="col" *ngFor="let product of products">
          <!-- Tarjeta de producto -->
          <ion-card class="product-card" (click)="onView(product)">
            <img 
              [src]="product.imageUrl || 'assets/images/placeholder.jpg'" 
              [alt]="product.name"
              (error)="product.imageUrl = 'assets/images/placeholder.jpg'"
              class="product-image">
            
            <ion-card-header>
              <ion-card-title class="product-title">{{ product.name }}</ion-card-title>
              <ion-card-subtitle class="product-brand">{{ product.brandName }}</ion-card-subtitle>
            </ion-card-header>
            
            <ion-card-content>
              <p class="product-description">{{ (product.description || '').slice(0, 60) }}...</p>
              
              <div class="product-details">
                <div class="product-info">
                  <span class="product-size">{{ product.sizeMl }}ml</span>
                  <span class="product-category">{{ product.categoryName }}</span>
                </div>
                
                <div class="product-actions">
                  <strong class="product-price">${{ product.price }}</strong>
                  <ion-button 
                    size="small" 
                    (click)="addToCart(product); $event.stopPropagation()"
                    [disabled]="product.stock === 0"
                    class="add-to-cart-btn">
                    <ion-icon name="cart-outline" slot="start"></ion-icon>
                    {{ product.stock === 0 ? 'Sin Stock' : 'Agregar' }}
                  </ion-button>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
      </div>

      <!-- Estado vacío después de filtrar -->
      <div *ngIf="products.length === 0 && allProducts.length > 0" class="empty-state">
        <ion-icon name="search-outline"></ion-icon>
        <h3>No se encontraron productos</h3>
        <p>Intenta ajustar los filtros de búsqueda</p>
        <button class="btn-secondary" (click)="clearFilters()" style="margin-top: 1rem;">
          Limpiar filtros
        </button>
      </div>
    </div>

    <!-- Estado vacío cuando no hay productos -->
    <div *ngIf="!isLoading && !hasError && allProducts.length === 0" class="empty-state">
      <ion-icon name="cube-outline"></ion-icon>
      <h3>No hay productos disponibles</h3>
      <p>No se encontraron productos en la tienda</p>
      <button class="retry-button" (click)="loadInitialData()" style="margin-top: 1rem;">
        Reintentar
      </button>
    </div>
  </div>
</ion-content>