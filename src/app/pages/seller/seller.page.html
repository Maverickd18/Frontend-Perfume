<app-header 
  [title]="'My Products'" 
  [showBackButton]="true" 
  [unreadNotifications]="unreadNotifications" 
  (backClicked)="onBackClick()">
</app-header>

<ion-content>
  
  <!-- Welcome Section -->
  <ion-card class="welcome-card">
    <ion-card-header>
      <ion-card-title>Gestión de Productos</ion-card-title>
      <ion-card-subtitle>Administra tus perfumes y marcas</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      <p>Desde aquí puedes agregar nuevos perfumes, editar existentes y gestionar tus marcas y categorías.</p>
    </ion-card-content>
  </ion-card>

  <!-- Add Products Button -->
   <div class="ion-padding">
    <ion-button 
      expand="block" 
      (click)="openAddProductStepper()"
      class="add-product-btn">
      <ion-icon slot="start" name="add-circle"></ion-icon>
      Agregar Nuevo Perfume
    </ion-button>
  </div>

  <!-- Products List -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Mis Perfumes ({{ perfumes.length || 0 }})</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <!-- Toolbar with Delete Selected Button -->
      <div *ngIf="perfumes && perfumes.length > 0" class="ion-margin-bottom">
        <ion-button 
          fill="outline"
          color="danger"
          [disabled]="selectedPerfumes.size === 0"
          (click)="deleteSelectedPerfumes()">
          <ion-icon slot="start" name="trash"></ion-icon>
          Eliminar Seleccionados ({{ selectedPerfumes.size || 0 }})
        </ion-button>
      </div>

      <ion-list *ngIf="perfumes && perfumes.length > 0">
        <div *ngFor="let perfume of perfumes">
          <!-- Product Card View -->
          <ion-item-sliding *ngIf="editingPerfume?.id !== perfume.id">
            <ion-item>
              <ion-checkbox 
                slot="start" 
                [checked]="isSelected(perfume.id!)"
                (ionChange)="toggleSelectPerfume(perfume.id!)">
              </ion-checkbox>
              
              <!-- Imagen del perfume -->
              <ion-avatar slot="start" class="perfume-avatar">
                <img [src]="getPerfumeImage(perfume)" [alt]="perfume.name" (error)="perfume.imageUrl = null">
              </ion-avatar>
              
              <ion-label>
                <h2>{{ perfume.name }}</h2>
                <p>{{ perfume.description }}</p>
                <p *ngIf="perfume.brand">
                  <ion-icon name="business-outline"></ion-icon>
                  <strong>Marca:</strong> {{ perfume.brand.name }}
                </p>
                <p *ngIf="perfume.category">
                  <ion-icon name="pricetags-outline"></ion-icon>
                  <strong>Categoría:</strong> {{ perfume.category.name }}
                </p>
                <p>
                  <ion-icon name="cash-outline"></ion-icon>
                  <strong>Precio:</strong> ${{ perfume.price }} | 
                  <ion-icon name="cube-outline"></ion-icon>
                  <strong>Stock:</strong> {{ perfume.stock }} | 
                  <ion-icon name="resize-outline"></ion-icon>
                  <strong>Tamaño:</strong> {{ perfume.sizeMl }}ml | 
                  <ion-icon name="person-outline"></ion-icon>
                  <strong>Género:</strong> {{ perfume.genre }}
                </p>
              </ion-label>
            </ion-item>
            <ion-item-options side="end">
              <ion-item-option color="primary" (click)="startEditPerfume(perfume)">
                <ion-icon slot="icon-only" name="pencil"></ion-icon>
                Editar
              </ion-item-option>
              <ion-item-option color="danger" (click)="deletePerfume(perfume.id!)">
                <ion-icon slot="icon-only" name="trash"></ion-icon>
                Eliminar
              </ion-item-option>
            </ion-item-options>
          </ion-item-sliding>

          <!-- Edit Form inside Product Card -->
          <ion-card *ngIf="editingPerfume?.id === perfume.id" class="ion-margin-top ion-margin-bottom edit-card">
            <ion-card-header>
              <ion-card-title>Editar: {{ perfume.name }}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <ion-item>
                <ion-label position="stacked">Nombre del Producto *</ion-label>
                <ion-input 
                  [(ngModel)]="editingPerfume!.name" 
                  placeholder="e.g., Rose Perfume Premium">
                </ion-input>
              </ion-item>
              
              <ion-item>
                <ion-label position="stacked">Descripción *</ion-label>
                <ion-textarea 
                  [(ngModel)]="editingPerfume!.description" 
                  placeholder="Describe el aroma..."
                  rows="3">
                </ion-textarea>
              </ion-item>
              
              <ion-grid>
                <ion-row>
                  <ion-col size="6">
                    <ion-item>
                      <ion-label position="stacked">Precio ($) *</ion-label>
                      <ion-input 
                        type="number" 
                        [(ngModel)]="editingPerfume!.price" 
                        placeholder="150">
                      </ion-input>
                    </ion-item>
                  </ion-col>
                  <ion-col size="6">
                    <ion-item>
                      <ion-label position="stacked">Stock *</ion-label>
                      <ion-input 
                        type="number" 
                        [(ngModel)]="editingPerfume!.stock" 
                        placeholder="10">
                      </ion-input>
                    </ion-item>
                  </ion-col>
                </ion-row>
              </ion-grid>
              
              <ion-item>
                <ion-label position="stacked">Tamaño (ml) *</ion-label>
                <ion-input 
                  type="number" 
                  [(ngModel)]="editingPerfume!.sizeMl" 
                  placeholder="100">
                </ion-input>
              </ion-item>
              
              <ion-item>
                <ion-label position="stacked">Género</ion-label>
                <ion-select [(ngModel)]="editingPerfume!.genre" placeholder="Selecciona un género">
                  <ion-select-option value="Masculino">Masculino</ion-select-option>
                  <ion-select-option value="Femenino">Femenino</ion-select-option>
                  <ion-select-option value="Unisex">Unisex</ion-select-option>
                </ion-select>
              </ion-item>
              
              <div class="ion-margin-top action-buttons">
                <ion-button (click)="saveEditPerfume()" color="primary">
                  <ion-icon slot="start" name="save"></ion-icon>
                  Guardar Cambios
                </ion-button>
                <ion-button fill="outline" (click)="cancelEditPerfume()">
                  <ion-icon slot="start" name="close"></ion-icon>
                  Cancelar
                </ion-button>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
      </ion-list>

      <!-- Message if no products -->
      <div *ngIf="!perfumes || perfumes.length === 0" class="empty-state">
        <ion-icon name="cube-outline" class="empty-icon"></ion-icon>
        <h3>No hay perfumes aún</h3>
        <p>¡Crea tu primer perfume usando el botón de arriba!</p>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Cargando perfumes...</p>
      </div>
    </ion-card-content>
  </ion-card>

</ion-content>

<!-- Stepper Component Overlay -->
<app-stepper></app-stepper>

<app-footer></app-footer>