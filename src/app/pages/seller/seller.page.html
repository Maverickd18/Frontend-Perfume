<app-header [title]="'My Store'" [showBackButton]="true" [unreadNotifications]="store.nombre ? unreadNotifications : 0" (backClicked)="onBackClick()"></app-header>

<ion-content>
  
  <!-- Form to Create My Store (show only if store doesn't exist) -->
  <ion-card *ngIf="showCreateStore && !store.nombre">
    <ion-card-header>
      <ion-card-title>Create My Store</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <app-input 
        [label]="'Store Name'" 
        [placeholder]="'e.g., My Perfume Shop'"
        [type]="'text'"
        [(ngModel)]="newStore.nombre">
      </app-input>
      <app-input 
        [label]="'Description'" 
        [placeholder]="'Describe your store...'"
        [type]="'text'"
        [(ngModel)]="newStore.descripcion">
      </app-input>
      <app-input 
        [label]="'Owner Name'" 
        [placeholder]="'Your name'"
        [type]="'text'"
        [(ngModel)]="newStore.propietario">
      </app-input>
      <div class="ion-margin-top">
        <app-button [type]="'primary'" [text]="'Create Store'" (clicked)="createStore()"></app-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Store Info Card (show only after store is created) -->
  <ion-card *ngIf="store.nombre">
    <ion-card-header>
      <ion-card-title>{{ store.nombre }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <p>{{ store.descripcion }}</p>
      <p><strong>Owner:</strong> {{ store.propietario }}</p>
    </ion-card-content>
  </ion-card>

  <!-- Add Products Button (show only after store is created) -->
  <app-button *ngIf="store.nombre" [type]="'primary'" [icon]="'add-circle'" [iconPosition]="'start'" [text]="'Add Products'" (clicked)="openAddProductStepper()"></app-button>

  <!-- Products List (show only after store is created) -->
  <div *ngIf="store.nombre">
    <ion-card>
      <ion-card-header>
        <ion-card-title>My Products ({{ perfumes.length || 0 }})</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Toolbar with Delete Selected Button -->
        <div *ngIf="perfumes && perfumes.length > 0" class="ion-margin-bottom">
          <app-button 
            [type]="'outline'"
            [disabled]="selectedPerfumes.size === 0"
            [icon]="'trash'"
            [iconPosition]="'start'"
            [text]="'Delete Selected (' + (selectedPerfumes.size || 0) + ')'"
            (clicked)="deleteSelectedPerfumes()">
          </app-button>
        </div>

        <ion-list *ngIf="perfumes && perfumes.length > 0">
          <div *ngFor="let perfume of perfumes">
            <!-- Product Card View -->
            <ion-item-sliding *ngIf="editingPerfume?.id !== perfume.id">
              <ion-item>
                <ion-checkbox 
                  slot="start" 
                  [checked]="isSelected(perfume.id!)"
                  (ionChange)="toggleSelectPerfume(perfume.id!)">
                </ion-checkbox>
                <ion-label>
                  <h2>{{ perfume.nombre }}</h2>
                  <p>{{ perfume.descripcion }}</p>
                  <p *ngIf="perfume.categoria"><strong>Category:</strong> {{ perfume.categoria }}</p>
                  <p *ngIf="perfume.marca"><strong>Brand:</strong> {{ perfume.marca }}</p>
                  <p><strong>Price:</strong> ${{ perfume.precio }} | <strong>Stock:</strong> {{ perfume.stock }} | <strong>Size:</strong> {{ perfume.tamano_ml }}ml | <strong>Gender:</strong> {{ perfume.genero }}</p>
                </ion-label>
              </ion-item>
              <ion-item-options side="end">
                <ion-item-option color="primary" (click)="startEditPerfume(perfume)">
                  <ion-icon slot="icon-only" name="pencil"></ion-icon>
                </ion-item-option>
                <ion-item-option color="danger" (click)="deletePerfume(perfume.id!)">
                  <ion-icon slot="icon-only" name="trash"></ion-icon>
                </ion-item-option>
              </ion-item-options>
            </ion-item-sliding>

            <!-- Edit Form inside Product Card -->
            <ion-card *ngIf="editingPerfume?.id === perfume.id" class="ion-margin-top ion-margin-bottom">
              <ion-card-header>
                <ion-card-title>Edit: {{ perfume.nombre }}</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <app-input 
                  [label]="'Product Name'" 
                  [placeholder]="'e.g., Rose Perfume Premium'"
                  [type]="'text'"
                  [(ngModel)]="editingPerfume!.nombre">
                </app-input>
                <app-input 
                  [label]="'Description'" 
                  [placeholder]="'Describe the scent...'"
                  [type]="'text'"
                  [(ngModel)]="editingPerfume!.descripcion">
                </app-input>
                <app-input 
                  [label]="'Price ($)'" 
                  [placeholder]="'150'"
                  [type]="'number'"
                  [(ngModel)]="editingPerfume!.precio">
                </app-input>
                <app-input 
                  [label]="'Stock (Units)'" 
                  [placeholder]="'10'"
                  [type]="'number'"
                  [(ngModel)]="editingPerfume!.stock">
                </app-input>
                <app-input 
                  [label]="'Size (ml)'" 
                  [placeholder]="'100'"
                  [type]="'number'"
                  [(ngModel)]="editingPerfume!.tamano_ml">
                </app-input>
                <ion-item>
                  <ion-label position="floating">Gender</ion-label>
                  <ion-select [(ngModel)]="editingPerfume!.genero" placeholder="Select a gender">
                    <ion-select-option value="Masculine">Masculine</ion-select-option>
                    <ion-select-option value="Feminine">Feminine</ion-select-option>
                    <ion-select-option value="Unisex">Unisex</ion-select-option>
                  </ion-select>
                </ion-item>
                <div class="ion-margin-top">
                  <app-button [type]="'primary'" [text]="'Save Changes'" (clicked)="saveEditPerfume()"></app-button>
                  <app-button [type]="'outline'" [text]="'Cancel'" (clicked)="cancelEditPerfume()"></app-button>
                </div>
              </ion-card-content>
            </ion-card>
          </div>
        </ion-list>

        <!-- Message if no products -->
        <ion-text *ngIf="!perfumes || perfumes.length === 0" color="medium">
          <p class="ion-text-center ion-margin-top">No products yet. Create your first product!</p>
        </ion-text>
      </ion-card-content>
    </ion-card>
  </div>

</ion-content>

<!-- Stepper Component Overlay -->
<app-stepper></app-stepper>

<app-footer></app-footer>